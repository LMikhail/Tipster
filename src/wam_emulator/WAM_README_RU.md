# WAM Эмулятор на Clojure

Реализация классической машины Уорена (Warren Abstract Machine) для логического программирования, работающая с EDN-клаузами в стиле Tipster.

## Структура проекта

```
src/wam_emulator/core.clj  - Основной код эмулятора WAM
deps.edn                   - Зависимости проекта
run.sh                     - Запуск основного приложения
test.sh                    - Запуск тестов
repl.sh                    - Интерактивный REPL
debug.sh                   - Отладочный режим
```

## Использование

### Запуск основного приложения
```bash
./run.sh
```
Загружает и выводит информацию о программе-примере.

### Запуск тестов
```bash
./test.sh
```
Выполняет базовые тесты:
- Тест успешной унификации констант
- Тест неудачной унификации (с бэктрекингом)

### Интерактивный режим
```bash
./repl.sh
```
Запускает Clojure REPL с предзагруженным WAM эмулятором.

Доступные функции:
- `(wam/test-simple)` - Тест базовой функциональности
- `(wam/test-fail)` - Тест неудачной унификации
- `(wam/reset-wam!)` - Сброс состояния WAM
- `(wam/run-wam)` - Запуск текущей программы

Доступные переменные состояния:
- `@wam/X` - Аргументные регистры
- `@wam/heap` - Куча (heap)
- `@wam/program-code` - Текущая программа
- `@wam/P` - Program counter
- `@wam/stack` - Стек
- `@wam/trail` - Трейл

### Отладочный режим
```bash
./debug.sh
```
Выполняет простой тест с детальным выводом состояния до и после выполнения.

## Реализованные инструкции WAM

- `:put_constant` - Помещение константы в регистр
- `:get_constant` - Унификация регистра с константой
- `:get_variable` - Создание новой переменной
- `:try_me_else` - Создание точки выбора для бэктрекинга
- `:call` - Вызов предиката
- `:proceed` - Завершение выполнения/возврат

## Пример программы

Эмулятор загружает следующую тестовую программу на старте:

```
p(a).           # Факт: p(a) истинно
p(X) :- q(X).   # Правило: p(X) истинно, если q(X) истинно  
q(b).           # Факт: q(b) истинно
```

В WAM-байткоде это выглядит как:
```clojure
[[:try_me_else 4]      ; Точка выбора для p/1
 [:get_constant 'a 0]  ; Унификация X[0] с 'a
 [:proceed]            ; Завершение

 [:retry_me_else 0]    ; Альтернатива для p/1
 [:get_variable 'X 0]  ; Создание переменной X в X[0]
 [:call 'q-1 0]        ; Вызов q/1
 [:proceed]            ; Завершение

 [:get_constant 'b 0]  ; Унификация X[0] с 'b (для q/1)
 [:proceed]]           ; Завершение
```

## Архитектура

WAM эмулятор состоит из:

### Регистры
- **P** - Program counter (указатель программы)
- **CP** - Continuation pointer (адрес возврата)
- **E** - Environment pointer (указатель окружения)
- **B** - Backtrack pointer (указатель бэктрекинга)
- **H** - Heap pointer (указатель кучи)
- **X** - Аргументные регистры (8 регистров)

### Области памяти
- **Heap** - Куча для хранения структур и термов
- **Stack** - Стек для окружений и точек выбора
- **Trail** - Трейл для отслеживания связываний переменных

### Представление термов
Термы представляются с помощью тегированных структур:
- `{:tag :const :value val}` - Константы
- `{:tag :var :id id}` - Переменные
- `{:tag :ref :addr addr}` - Ссылки
- `{:tag :struct :functor name :arity n}` - Структуры

## Ограничения текущей реализации

- Ограниченный набор инструкций WAM
- Простая таблица символов (жестко заданные адреса)
- Нет оптимизаций (tail recursion, indexing)
- Нет сборки мусора
- Упрощенная обработка структур и списков

## Дальнейшее развитие

- Реализация полного набора инструкций WAM
- Добавление компилятора Tipster EDN -> WAM байткод
- Оптимизации производительности
- Интеграция с системой типов Tipster 
